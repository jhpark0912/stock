# GCP VM 환경용 Docker Compose Override
# 이 파일은 docker compose up 시 자동으로 적용됨
# Artifact Registry 이미지 + SSL 설정 포함

services:
  # Backend API
  backend:
    # Artifact Registry 이미지 사용
    image: ${REGION:-us-central1}-docker.pkg.dev/${GCP_PROJECT_ID}/stock-app/stock-backend:latest
    environment:
      # HTTPS Origin 추가 (SSL 사용 시)
      - ALLOWED_ORIGINS=https://${DOMAIN:-localhost},https://www.${DOMAIN:-localhost},http://${DOMAIN:-localhost},http://localhost,http://localhost:80,http://frontend,http://${SERVER_IP:-*}
    # SSL 사용 시 외부 노출 제거 (Nginx를 통해서만 접근)
    ports: []
    expose:
      - "8000"

  # Frontend Web
  frontend:
    # Artifact Registry 이미지 사용
    image: ${REGION:-us-central1}-docker.pkg.dev/${GCP_PROJECT_ID}/stock-app/stock-frontend:latest
    # SSL 사용 시 외부 노출 제거 (Nginx를 통해서만 접근)
    ports: []
    expose:
      - "80"

  # Nginx Reverse Proxy (SSL Termination)
  nginx:
    image: nginx:alpine
    container_name: stock-nginx
    ports:
      - "80:80"      # HTTP (Certbot 인증 + HTTPS 리디렉션)
      - "443:443"    # HTTPS
    volumes:
      # Nginx 설정
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # Let's Encrypt 인증서
      - certbot-etc:/etc/letsencrypt:ro
      - certbot-var:/var/lib/letsencrypt:ro
      # Certbot ACME Challenge
      - certbot-www:/var/www/certbot:ro
    depends_on:
      - backend
      - frontend
    restart: unless-stopped
    networks:
      - stock-network
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # Certbot (Let's Encrypt 자동 SSL 인증서 발급/갱신)
  certbot:
    image: certbot/certbot:latest
    container_name: stock-certbot
    volumes:
      # 인증서 저장
      - certbot-etc:/etc/letsencrypt
      - certbot-var:/var/lib/letsencrypt
      # ACME Challenge 응답
      - certbot-www:/var/www/certbot
    # 자동 갱신 (12시간마다 체크, 만료 30일 이내 시 갱신)
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot --quiet; sleep 12h & wait $${!}; done;'"
    restart: unless-stopped
    networks:
      - stock-network
    deploy:
      resources:
        limits:
          memory: 128M

volumes:
  # Let's Encrypt 인증서 볼륨
  certbot-etc:
    driver: local
  certbot-var:
    driver: local
  certbot-www:
    driver: local
